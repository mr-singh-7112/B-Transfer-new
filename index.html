<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6366f1">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÄ</text></svg>">
    <title>B-Transfer Pro - Secure File Sharing</title>
    <meta name="description" content="Professional file transfer solution with encryption and compression">
    <meta name="cache-control" content="no-cache, no-store, must-revalidate">
    <meta name="pragma" content="no-cache">
    <meta name="expires" content="0">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f8fafc;
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--gray-900);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            color: var(--white);
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #ffffff 0%, #e0e7ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.125rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .brand {
            font-size: 0.875rem;
            opacity: 0.7;
            margin-top: 0.5rem;
        }

        .main-content {
            background: var(--white);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            flex: 1;
        }

        .content-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--white);
            padding: 2rem;
            text-align: center;
        }

        .content-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .content-header p {
            opacity: 0.9;
            font-size: 0.875rem;
        }

        .upload-section {
            padding: 2rem;
        }

        .upload-area {
            border: 3px dashed var(--gray-300);
            border-radius: var(--border-radius-lg);
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: var(--gray-50);
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: var(--light);
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: var(--light);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.7;
        }

        .upload-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            color: var(--gray-500);
            font-size: 0.875rem;
        }

        .upload-features {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .feature {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        .progress-container {
            display: none;
            margin: 2rem 0;
            background: var(--gray-100);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            padding: 1rem;
            text-align: center;
            font-weight: 500;
            color: var(--gray-700);
        }

        .status {
            display: none;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            font-weight: 500;
        }

        .status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        .file-list-section {
            padding: 2rem;
            border-top: 1px solid var(--gray-200);
        }

        .file-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .file-list-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .file-count {
            background: var(--primary);
            color: var(--white);
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .file-list {
            display: grid;
            gap: 1rem;
        }

        .file-item {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .file-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-500);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }

        .stats-section {
            background: var(--gray-50);
            padding: 2rem;
            border-top: 1px solid var(--gray-200);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow-sm);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--gray-600);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .install-banner {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            margin: 2rem 0;
            display: none;
        }

        .install-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .install-icon {
            font-size: 2rem;
        }

        .install-text {
            flex: 1;
        }

        .install-text strong {
            display: block;
            font-size: 1.125rem;
            margin-bottom: 0.25rem;
        }

        .install-text small {
            opacity: 0.9;
            font-size: 0.875rem;
        }

        .install-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid var(--white);
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .install-btn:hover {
            background: var(--white);
            color: var(--primary);
        }

        .install-close {
            background: none;
            border: none;
            color: var(--white);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .install-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .theme-toggle {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--white);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 1.25rem;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .theme-toggle:hover {
            transform: rotate(180deg);
            box-shadow: var(--shadow-xl);
        }

        .security-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: var(--white);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            margin: 0.5rem;
        }

        input[type="file"] {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .content-header {
                padding: 1.5rem;
            }

            .upload-section {
                padding: 1.5rem;
            }

            .upload-area {
                padding: 2rem 1rem;
            }

            .upload-features {
                flex-direction: column;
                gap: 1rem;
            }

            .file-list-section {
                padding: 1.5rem;
            }

            .file-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .file-actions {
                width: 100%;
                justify-content: space-between;
            }

            .btn {
                flex: 1;
                justify-content: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .install-content {
                flex-direction: column;
                text-align: center;
            }

            .install-btn {
                width: 100%;
                margin-top: 1rem;
            }

            .theme-toggle {
                top: 1rem;
                right: 1rem;
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }
        
        .upload-loading {
            margin-top: 1rem;
            text-align: center;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--gray-200);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        .loading-text {
            color: var(--gray-600);
            font-size: 0.875rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .upload-area.uploading {
            border-color: var(--primary);
            background: var(--light);
        }
        
        .upload-area.uploading .upload-text {
            color: var(--primary);
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">üåì</button>
    
    <div class="container">
        <div class="header">
            <h1>B-Transfer Pro</h1>
            <p>Secure, fast, and professional file sharing</p>
            <div class="brand">by Balsim Productions</div>
        </div>

        <div class="main-content">
            <div class="content-header">
                <h2>üöÄ Professional File Transfer</h2>
                <p>End-to-end encryption ‚Ä¢ Smart compression ‚Ä¢ Auto-cleanup</p>
            </div>

            <div class="install-banner" id="installBanner">
                <div class="install-content">
                    <span class="install-icon">üì±</span>
                    <div class="install-text">
                        <strong>Install as Native App</strong>
                        <small>üì± Works offline ‚Ä¢ ‚ö° Faster access ‚Ä¢ üîê Secure</small>
                    </div>
                    <button class="install-btn" id="installButton">Install Now</button>
                    <button class="install-close" id="closeBanner">√ó</button>
                </div>
            </div>

            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Drop files here or click to select</div>
                    <div class="upload-subtext">Up to 5GB per file ‚Ä¢ All types supported ‚Ä¢ Auto-delete in 24h</div>
                    
                    <div class="upload-features">
                        <div class="feature">
                            <span>üîê</span>
                            <span>End-to-end encryption</span>
                        </div>
                        <div class="feature">
                            <span>üóúÔ∏è</span>
                            <span>Smart compression</span>
                        </div>
                        <div class="feature">
                            <span>‚ö°</span>
                            <span>Lightning fast</span>
                        </div>
                    </div>
                </div>

                <input type="file" id="fileInput" multiple>

                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Uploading...</div>
                </div>

                <div class="status" id="status"></div>
            </div>

            <div class="file-list-section" id="fileListSection" style="display: none;">
                <div class="file-list-header">
                    <h3 class="file-list-title">üìÅ Your Files</h3>
                    <span class="file-count" id="fileCount">0 files</span>
                </div>
                <div class="file-list" id="fileList"></div>
            </div>

            <div class="stats-section" id="statsSection" style="display: none;">
                <div class="stats-grid" id="statsGrid"></div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const status = document.getElementById('status');
        const fileList = document.getElementById('fileList');
        const fileListSection = document.getElementById('fileListSection');
        const fileCount = document.getElementById('fileCount');
        const statsSection = document.getElementById('statsSection');
        const statsGrid = document.getElementById('statsGrid');
        const installBanner = document.getElementById('installBanner');
        const installButton = document.getElementById('installButton');
        const closeBanner = document.getElementById('closeBanner');

        // State
        let currentTheme = localStorage.getItem('theme') || 'light';
        let uploadCounter = parseInt(localStorage.getItem('uploadsToday') || '0');
        let lastUploadDate = localStorage.getItem('lastUploadDate');
        let fileTokens = JSON.parse(localStorage.getItem('fileTokens') || '{}');
        let deferredPrompt;

        // Reset counter if it's a new day
        const today = new Date().toDateString();
        if (lastUploadDate !== today) {
            uploadCounter = 0;
            localStorage.setItem('uploadsToday', '0');
            localStorage.setItem('lastUploadDate', today);
        }

        // Event Listeners
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handleFiles(files);
        });
        
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // File handling
        function handleFiles(files) {
            for (let file of files) {
                uploadFile(file);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üñºÔ∏è', 'webp': 'üñºÔ∏è',
                'mp4': 'üé•', 'avi': 'üé•', 'mov': 'üé•', 'mkv': 'üé•', 'webm': 'üé•',
                'mp3': 'üéµ', 'wav': 'üéµ', 'flac': 'üéµ', 'aac': 'üéµ',
                'pdf': 'üìÑ', 'doc': 'üìù', 'docx': 'üìù', 'txt': 'üìã', 'md': 'üìã',
                'zip': 'üì¶', 'rar': 'üì¶', '7z': 'üì¶', 'tar': 'üì¶', 'gz': 'üì¶',
                'xls': 'üìä', 'xlsx': 'üìä', 'ppt': 'üìΩÔ∏è', 'pptx': 'üìΩÔ∏è'
            };
            return icons[ext] || 'üìé';
        }

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            progressContainer.style.display = 'block';
            status.style.display = 'none';
            
            // Show upload area loading state
            uploadArea.classList.add('uploading');
            
            // Reset progress
            progressFill.style.width = '0%';
            progressText.textContent = `Preparing to upload ${file.name}...`;
            
            const xhr = new XMLHttpRequest();
            const startTime = Date.now();
            
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    const elapsed = (Date.now() - startTime) / 1000;
                    const rate = e.loaded / elapsed; // bytes per second
                    const remaining = (e.total - e.loaded) / rate; // seconds remaining
                    
                    progressFill.style.width = percentComplete + '%';
                    
                    // Format time remaining
                    let timeText = '';
                    if (remaining > 60) {
                        const minutes = Math.floor(remaining / 60);
                        const seconds = Math.floor(remaining % 60);
                        timeText = `${minutes}m ${seconds}s remaining`;
                    } else {
                        timeText = `${Math.floor(remaining)}s remaining`;
                    }
                    
                    // Format upload speed
                    let speedText = '';
                    if (rate > 1024 * 1024) {
                        speedText = `${(rate / (1024 * 1024)).toFixed(1)} MB/s`;
                    } else if (rate > 1024) {
                        speedText = `${(rate / 1024).toFixed(1)} KB/s`;
                    } else {
                        speedText = `${Math.floor(rate)} B/s`;
                    }
                    
                    progressText.textContent = `Uploading ${file.name}... ${Math.round(percentComplete)}% (${speedText}) - ${timeText}`;
                }
            });
            
            xhr.addEventListener('load', () => {
                progressContainer.style.display = 'none';
                uploadArea.classList.remove('uploading');
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        const ownerToken = xhr.getResponseHeader('X-Owner-Token');
                        
                        console.log('Upload response:', response);
                        console.log('Owner token from header:', ownerToken);
                        
                        if (ownerToken) {
                            fileTokens[file.name] = ownerToken;
                            localStorage.setItem('fileTokens', JSON.stringify(fileTokens));
                            console.log('Token saved for file:', file.name);
                        } else if (response.owner_token) {
                            fileTokens[file.name] = response.owner_token;
                            localStorage.setItem('fileTokens', JSON.stringify(fileTokens));
                            console.log('Token saved from response for file:', file.name);
                        } else {
                            console.warn('No token received for file:', file.name);
                        }
                        
                        let message = '‚úÖ File uploaded successfully!';
                        if (response.was_compressed) {
                            const saved = response.original_size - response.compressed_size;
                            const savedPercent = Math.round((saved / response.original_size) * 100);
                            message += ` (${savedPercent}% space saved)`;
                        }
                        
                        showStatus(message, 'success');
                        
                        // Force immediate refresh of file list
                        loadFileList();
                        loadStats();
                        updateUploadCounter();
                    } catch (e) {
                        console.error('Upload response parsing error:', e);
                        showStatus('‚úÖ File uploaded successfully!', 'success');
                        loadFileList();
                        loadStats();
                        updateUploadCounter();
                    }
                } else {
                    showStatus(`‚ùå Upload failed (${xhr.status}). Please try again.`, 'error');
                }
            });
            
            xhr.addEventListener('error', (e) => {
                progressContainer.style.display = 'none';
                uploadArea.classList.remove('uploading');
                console.error('Upload error:', e);
                showStatus('‚ùå Upload failed. Please check your connection and try again.', 'error');
            });
            
            xhr.addEventListener('abort', () => {
                progressContainer.style.display = 'none';
                uploadArea.classList.remove('uploading');
                showStatus('‚ùå Upload cancelled.', 'error');
            });
            
            xhr.open('POST', '/upload');
            xhr.send(formData);
        }

        function deleteFile(filename) {
            const token = fileTokens[filename];
            if (!token) {
                showStatus('You can only delete files you uploaded!', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
                return;
            }
            
            fetch(`/delete/${encodeURIComponent(filename)}`, {
                method: 'DELETE',
                headers: {
                    'X-Owner-Token': token
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    delete fileTokens[filename];
                    localStorage.setItem('fileTokens', JSON.stringify(fileTokens));
                    showStatus('üóëÔ∏è File deleted successfully!', 'success');
                    loadFileList();
                    loadStats();
                } else {
                    showStatus('‚ùå Failed to delete file.', 'error');
                }
            })
            .catch(err => {
                showStatus('‚ùå Failed to delete file.', 'error');
            });
        }

        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        function updateUploadCounter() {
            uploadCounter++;
            localStorage.setItem('uploadsToday', uploadCounter.toString());
            localStorage.setItem('lastUploadDate', today);
        }

        function loadFileList() {
            fetch('/files')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(files => {
                    const validFiles = files.filter(file => 
                        file.name && 
                        file.name !== '.gitkeep' && 
                        !file.name.endsWith('.token') &&
                        !file.name.endsWith('.meta') &&
                        !file.name.startsWith('.') &&
                        file.name.trim() !== ''
                    );
                    
                    if (validFiles.length === 0) {
                        fileListSection.style.display = 'none';
                        return;
                    }
                    
                    fileListSection.style.display = 'block';
                    fileCount.textContent = `${validFiles.length} file${validFiles.length !== 1 ? 's' : ''}`;
                    
                    fileList.innerHTML = '';
                    
                    validFiles.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item fade-in';
                        
                        const canDelete = fileTokens[file.name] ? true : false;
                        const originalSize = file.original_size || file.size;
                        const wasCompressed = file.was_compressed || false;
                        
                        let sizeInfo = formatFileSize(originalSize);
                        if (wasCompressed && file.size !== originalSize) {
                            const saved = originalSize - file.size;
                            const savedPercent = Math.round((saved / originalSize) * 100);
                            sizeInfo += ` (${savedPercent}% saved)`;
                        }
                        
                        fileItem.innerHTML = `
                            <div class="file-info">
                                <div class="file-name">
                                    ${getFileIcon(file.name)} ${file.name}
                                    ${canDelete ? '<span class="security-badge">üîê Your file</span>' : '<span style="color: var(--gray-500); font-size: 0.875rem;">üë§ Shared file</span>'}
                                </div>
                                <div class="file-meta">
                                    <span>üìä ${sizeInfo}</span>
                                    <span>‚è∞ Available for 24h</span>
                                </div>
                            </div>
                            <div class="file-actions">
                                <a href="/download/${encodeURIComponent(file.name)}" 
                                   class="btn btn-primary" download>
                                    üíæ Download
                                </a>
                                ${canDelete ? `<button onclick="deleteFile('${file.name}')" class="btn btn-danger">üóëÔ∏è Delete</button>` : '<span style="color: var(--gray-500); font-size: 0.875rem; padding: 0.75rem;">üîí Protected</span>'}
                            </div>
                        `;
                        
                        fileList.appendChild(fileItem);
                    });
                })
                .catch(err => {
                    console.error('Error loading files:', err);
                    showStatus(`‚ùå Could not load files: ${err.message}`, 'error');
                });
        }

        function loadStats() {
            fetch('/analytics')
                .then(response => response.json())
                .then(data => {
                    if (data.total_files > 0) {
                        statsSection.style.display = 'block';
                        statsGrid.innerHTML = `
                            <div class="stat-card">
                                <div class="stat-value">${data.total_files}</div>
                                <div class="stat-label">Total Files</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${formatFileSize(data.total_size)}</div>
                                <div class="stat-label">Total Size</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.today_uploads}</div>
                                <div class="stat-label">Today's Uploads</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.compression_ratio}%</div>
                                <div class="stat-label">Space Saved</div>
                            </div>
                        `;
                    } else {
                        statsSection.style.display = 'none';
                    }
                })
                .catch(err => console.log('Analytics not available:', err));
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.style.filter = currentTheme === 'dark' ? 'invert(1) hue-rotate(180deg)' : 'none';
            localStorage.setItem('theme', currentTheme);
        }

        // PWA Install functionality
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            if (!localStorage.getItem('installBannerClosed')) {
                installBanner.style.display = 'block';
            }
        });

        if (installButton) {
            installButton.addEventListener('click', async () => {
                if (deferredPrompt) {
                    try {
                        await deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        
                        if (outcome === 'accepted') {
                            showStatus('üéâ B-Transfer installed successfully!', 'success');
                            localStorage.setItem('appInstalled', 'true');
                        } else {
                            showStatus('üì± You can install B-Transfer anytime from your browser menu!', 'info');
                        }
                    } catch (error) {
                        console.error('Install error:', error);
                        showStatus('üì± Look for "Install App" in your browser menu!', 'info');
                    }
                    
                    deferredPrompt = null;
                    installBanner.style.display = 'none';
                } else {
                    showStatus('üì± Look for "Install App" in your browser menu!', 'info');
                }
            });
        }

        if (closeBanner) {
            closeBanner.addEventListener('click', () => {
                installBanner.style.display = 'none';
                localStorage.setItem('installBannerClosed', 'true');
            });
        }

        // Initialize
        if (currentTheme === 'dark') {
            toggleTheme();
        }

        // Load data on page load
        loadFileList();
        loadStats();

        // Refresh when tab becomes visible
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                loadFileList();
                loadStats();
            }
        });

        // Service Worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // Check if app is already installed
        if (window.matchMedia('(display-mode: standalone)').matches) {
            installBanner.style.display = 'none';
        }
    </script>
</body>
</html> 